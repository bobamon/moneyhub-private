<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>My Money Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0d6efd">
  <style>
    :root { --pad: 14px; }
    body { background:#0b1220; color:#e9eef7; }
    .navbar { background:#0d1b2a !important; }
    .card { background:#132235; border:1px solid rgba(255,255,255,.06); }
    .form-control, .form-select { background:#0f1d2d; border-color:#21344d; color:#e9eef7; }
    .form-control::placeholder{color:#9db3cf}
    .table { --bs-table-color:#cfe0f6; --bs-table-bg:transparent; --bs-table-border-color:#243852; }
    .badge-soft { background: rgba(13,110,253,.15); color:#8db6ff; }
    .ring { border:2px solid rgba(255,255,255,.08); border-radius:12px; padding: var(--pad); }
    .sticky-footer { position:sticky; bottom:0; background:#0d1b2a; border-top:1px solid rgba(255,255,255,.08); }
    .progress { background:#0f1d2d; }
    .small-muted { color:#9db3cf; font-size:.9rem; }
    .pointer { cursor:pointer }
  </style>
</head>
<body>
<nav class="navbar navbar-dark px-3">
  <div class="d-flex align-items-center gap-2">
    <i class="bi bi-wallet2 fs-4 text-primary"></i>
    <span class="navbar-brand mb-0 h1">My Money Hub</span>
  </div>
  <div class="d-flex align-items-center gap-2">
    <form method="post" action="/logout" class="me-2">
      <button class="btn btn-outline-light btn-sm"><i class="bi bi-box-arrow-right"></i> Logout</button>
    </form>
    <button id="exportBtn" class="btn btn-outline-light btn-sm"><i class="bi bi-download"></i> Export</button>
    <label class="btn btn-outline-light btn-sm mb-0">
      <i class="bi bi-upload"></i> Import <input id="importFile" type="file" accept="application/json" hidden>
    </label>
  </div>
</nav>

<main class="container py-3">
  <!-- DASHBOARD -->
  <section id="dashboard" class="mb-4">
    <div class="row g-3">
      <div class="col-6 col-md-3">
        <div class="card p-3 ring h-100">
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-secondary">Net Worth</span>
            <i class="bi bi-graph-up text-success"></i>
          </div>
          <h3 class="mt-2" id="netWorth">$0</h3>
          <small class="text-secondary">Assets âˆ’ Debts</small>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card p-3 ring h-100">
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-secondary">Cash on Hand</span>
            <i class="bi bi-cash-coin text-warning"></i>
          </div>
          <h3 class="mt-2" id="cashOnHand">$0</h3>
          <small class="text-secondary">Not in bank</small>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card p-3 ring h-100">
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-secondary">Bank Balances</span>
            <i class="bi bi-bank text-info"></i>
          </div>
          <h3 class="mt-2" id="bankTotal">$0</h3>
          <small class="text-secondary" id="acctCount">0 accounts</small>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card p-3 ring h-100">
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-secondary">Investments</span>
            <i class="bi bi-currency-bitcoin text-primary"></i>
          </div>
          <h3 class="mt-2" id="investTotal">$0</h3>
          <small class="text-secondary">Holdings value</small>
        </div>
      </div>
    </div>

    <!-- Dashboard charts -->
    <div class="row g-3 mt-1">
      <div class="col-12 col-lg-6">
        <div class="card p-3 ring h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Net Worth (last 12 months)</h5>
          </div>
          <canvas id="chartNetWorth" height="140"></canvas>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card p-3 ring h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Spending by Month</h5>
          </div>
          <canvas id="chartSpending" height="140"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- QUICK ADD ROW -->
  <section class="mb-4">
    <div class="card p-3 ring">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-sm-6 col-md-3">
          <label class="form-label">Cash on Hand</label>
          <div class="input-group">
            <span class="input-group-text">$</span>
            <input id="cashInput" type="number" step="0.01" class="form-control" placeholder="0.00" />
            <button class="btn btn-primary" id="saveCash">Save</button>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Upcoming Bill</label>
          <input id="billName" class="form-control" placeholder="e.g. Phone" />
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Amount</label>
          <input id="billAmt" type="number" step="0.01" class="form-control" placeholder="0.00" />
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Due</label>
          <input id="billDue" type="date" class="form-control" />
        </div>
        <div class="col-12 col-md-2 d-grid">
          <button id="addBill" class="btn btn-outline-primary"><i class="bi bi-plus"></i> Add Bill</button>
        </div>
      </div>
    </div>
  </section>

  <!-- TABS -->
  <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="pills-accounts-tab" data-bs-toggle="pill" data-bs-target="#pills-accounts" type="button" role="tab">Accounts</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pills-investments-tab" data-bs-toggle="pill" data-bs-target="#pills-investments" type="button" role="tab">Investments</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pills-flips-tab" data-bs-toggle="pill" data-bs-target="#pills-flips" type="button" role="tab">Flips</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pills-transactions-tab" data-bs-toggle="pill" data-bs-target="#pills-transactions" type="button" role="tab">Transactions</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pills-bills-tab" data-bs-toggle="pill" data-bs-target="#pills-bills" type="button" role="tab">Upcoming</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pills-budget-tab" data-bs-toggle="pill" data-bs-target="#pills-budget" type="button" role="tab">Budgets</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pills-settings-tab" data-bs-toggle="pill" data-bs-target="#pills-settings" type="button" role="tab">Settings</button>
    </li>
  </ul>

  <div class="tab-content" id="pills-tabContent">
    <!-- Accounts -->
    <div class="tab-pane fade show active" id="pills-accounts" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-lg-4">
          <div class="card p-3 ring">
            <h5 class="mb-3">Add Account</h5>
            <div class="mb-2">
              <label class="form-label">Name</label>
              <input id="acctName" class="form-control" placeholder="e.g. Chase Checking" />
            </div>
            <div class="mb-2">
              <label class="form-label">Type</label>
              <select id="acctType" class="form-select">
                <option>Checking</option>
                <option>Savings</option>
                <option>Credit Card</option>
                <option>Cash</option>
                <option>Other</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Balance</label>
              <input id="acctBalance" type="number" step="0.01" class="form-control" placeholder="0.00" />
            </div>
            <div class="d-grid gap-2">
              <button id="addAcct" class="btn btn-primary">Save Account</button>
              <button id="resetDemo" class="btn btn-outline-light">Load Demo Data</button>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-8">
          <div class="card p-3 ring">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Accounts</h5>
              <span class="badge badge-soft" id="acctSummary">0 accounts</span>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle" id="acctTable">
                <thead><tr><th>Name</th><th>Type</th><th class="text-end">Balance</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Investments -->
    <div class="tab-pane fade" id="pills-investments" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-lg-4">
          <div class="card p-3 ring">
            <h5 class="mb-3">Add Holding</h5>
            <div class="mb-2">
              <label class="form-label">Symbol / Name</label>
              <input id="invSymbol" class="form-control" placeholder="e.g. VTI or BTC or 'iPhone 12 lot'" />
            </div>
            <div class="mb-2">
              <label class="form-label">Category</label>
              <select id="invCat" class="form-select">
                <option>Stock</option>
                <option>Crypto</option>
                <option>Flip</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Sub-Category (optional)</label>
              <input id="invSubcat" class="form-control" placeholder="e.g. PokÃ©mon flipping, iPhone flipping" />
            </div>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Quantity</label>
                <input id="invQty" type="number" step="0.0001" class="form-control" placeholder="0" />
              </div>
              <div class="col-6">
                <label class="form-label">Price (manual)</label>
                <input id="invPrice" type="number" step="0.01" class="form-control" placeholder="0.00" />
              </div>
            </div>

            <hr class="my-2">
            <h6 class="mb-2">Dividends (optional, for stocks/ETFs)</h6>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Dividend / Share</label>
                <input id="invDivPS" type="number" step="0.0001" class="form-control" placeholder="e.g. 0.20" />
              </div>
              <div class="col-6">
                <label class="form-label">Frequency</label>
                <select id="invDivFreq" class="form-select">
                  <option value="none">None</option>
                  <option value="monthly">Monthly</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="semiannual">Semiannual</option>
                  <option value="annual">Annual</option>
                </select>
              </div>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="invDrip">
              <label class="form-check-label" for="invDrip">Reinvest dividends (DRIP)</label>
            </div>

            <div class="d-grid mt-2"><button id="addInv" class="btn btn-primary">Save Holding</button></div>
            <small class="text-secondary d-block mt-2">(Optional) Update prices manually for now. Live quotes can be added later.</small>
          </div>
        </div>
        <div class="col-12 col-lg-8">
          <div class="card p-3 ring">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Holdings</h5>
              <span class="badge badge-soft" id="invSummary">0 holdings</span>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle" id="invTable">
                <thead><tr><th>Symbol</th><th>Cat</th><th>Sub</th><th class="text-end">Qty</th><th class="text-end">Price</th><th class="text-end">Value</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Dividend Projections -->
          <div class="card p-3 ring mt-3">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Dividend Projections</h5>
            </div>
            <div class="row g-2 align-items-end mt-2">
              <div class="col-12 col-md-4">
                <label class="form-label">Holding</label>
                <select id="projHolding" class="form-select"></select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Years</label>
                <input id="projYears" type="number" min="1" max="30" value="10" class="form-control" />
              </div>
              <div class="col-6 col-md-3">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="projDrip">
                  <label class="form-check-label" for="projDrip">Reinvest dividends (override)</label>
                </div>
              </div>
            </div>

            <div class="row g-3 mt-2">
              <div class="col-12 col-lg-7">
                <canvas id="chartDividend" height="180"></canvas>
              </div>
              <div class="col-12 col-lg-5">
                <div class="table-responsive" style="max-height:240px;">
                  <table class="table table-sm" id="projTable">
                    <thead>
                      <tr><th>Period</th><th class="text-end">Shares</th><th class="text-end">Income</th><th class="text-end">Cum</th></tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Flips -->
    <div class="tab-pane fade" id="pills-flips" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-xl-4">
          <div class="card p-3 ring">
            <h5 class="mb-2">Add Flip Entry</h5>
            <div class="mb-2">
              <label class="form-label">Date</label>
              <input id="flipDate" type="date" class="form-control"/>
            </div>
            <div class="mb-2">
              <label class="form-label">Sub-Category</label>
              <input id="flipSubcat" class="form-control" placeholder="e.g. PokÃ©mon, iPhones"/>
            </div>
            <div class="mb-2">
              <label class="form-label">Item</label>
              <input id="flipItem" class="form-control" placeholder="e.g. Charizard PSA 9"/>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Side</label>
                <select id="flipSide" class="form-select">
                  <option value="buy">Buy</option>
                  <option value="sell">Sell</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label">Qty</label>
                <input id="flipQty" type="number" step="1" class="form-control" value="1"/>
              </div>
            </div>
            <div class="row g-2 mt-1">
              <div class="col-6">
                <label class="form-label">Unit Price</label>
                <input id="flipPrice" type="number" step="0.01" class="form-control" placeholder="0.00"/>
              </div>
              <div class="col-6">
                <label class="form-label">Fees/Shipping</label>
                <input id="flipFees" type="number" step="0.01" class="form-control" value="0"/>
              </div>
            </div>
            <div class="d-grid mt-3">
              <button id="addFlip" class="btn btn-primary">Save Flip</button>
            </div>
            <small class="small-muted mt-2 d-block">Use subcategories to group (PokÃ©mon, iPhoneâ€¦). Weâ€™ll track ROI & inventory automatically.</small>
          </div>
        </div>
        <div class="col-12 col-xl-8">
          <div class="card p-3 ring">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Flip Performance</h5>
              <span id="flipSummary" class="badge badge-soft">0 entries</span>
            </div>
            <div class="table-responsive" style="max-height:360px;">
              <table class="table table-sm align-middle" id="flipTable">
                <thead>
                  <tr>
                    <th>Sub</th><th>Item</th><th>Date</th><th>Side</th>
                    <th class="text-end">Qty</th><th class="text-end">Unit</th>
                    <th class="text-end">Fees</th><th class="text-end">Total</th><th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <div class="card p-3 ring mt-3">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">ROI by Subcategory</h5>
            </div>
            <canvas id="chartFlipROI" height="160"></canvas>
            <div class="table-responsive mt-2">
              <table class="table table-sm" id="flipAggTable">
                <thead><tr><th>Sub</th><th class="text-end">Cost</th><th class="text-end">Proceeds</th><th class="text-end">P&L</th><th class="text-end">ROI %</th><th class="text-end">Inventory</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Transactions -->
    <div class="tab-pane fade" id="pills-transactions" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-xl-4">
          <div class="card p-3 ring">
            <h5 class="mb-3">Add Transaction</h5>
            <div class="mb-2">
              <label class="form-label">Date</label>
              <input id="txDate" type="date" class="form-control" />
            </div>
            <div class="mb-2">
              <label class="form-label">Description</label>
              <input id="txDesc" class="form-control" placeholder="e.g. Groceries" />
            </div>
            <div class="mb-2">
              <label class="form-label">Category</label>
              <select id="txCat" class="form-select"></select>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Amount</label>
                <input id="txAmt" type="number" step="0.01" class="form-control" placeholder="-45.65 (expense)" />
              </div>
              <div class="col-6">
                <label class="form-label">Account</label>
                <select id="txAcct" class="form-select"></select>
              </div>
            </div>
            <div class="d-grid mt-3">
              <button id="addTx" class="btn btn-primary">Save Transaction</button>
            </div>
            <hr/>
            <div class="d-grid">
              <label class="btn btn-outline-light mb-2">Import CSV <input id="csvTx" type="file" accept=".csv" hidden></label>
              <small class="text-secondary">CSV headers: date,description,amount,category,account</small>
            </div>
          </div>
        </div>
        <div class="col-12 col-xl-8">
          <div class="card p-3 ring">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Transactions</h5>
              <div class="d-flex gap-2">
                <select id="filterCat" class="form-select form-select-sm" style="width:160px"></select>
                <select id="filterAcct" class="form-select form-select-sm" style="width:160px"></select>
              </div>
            </div>
            <div class="table-responsive" style="max-height:420px;">
              <table class="table table-sm align-middle" id="txTable">
                <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Account</th><th class="text-end">Amount</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bills / Upcoming -->
    <div class="tab-pane fade" id="pills-bills" role="tabpanel">
      <div class="card p-3 ring">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Upcoming Expenses</h5>
          <span class="text-secondary" id="billSummary">0 scheduled</span>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle" id="billTable">
            <thead><tr><th>Bill</th><th>Due</th><th class="text-end">Amount</th><th>Status</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Budgets -->
    <div class="tab-pane fade" id="pills-budget" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-lg-4">
          <div class="card p-3 ring">
            <h5 class="mb-3">Add Monthly Budget</h5>
            <div class="mb-2">
              <label class="form-label">Category</label>
              <input id="budCat" class="form-control" placeholder="e.g. Groceries" />
            </div>
            <div class="mb-2">
              <label class="form-label">Monthly Limit</label>
              <input id="budAmt" type="number" step="0.01" class="form-control" placeholder="300" />
            </div>
            <div class="d-grid"><button id="addBudget" class="btn btn-primary">Save Budget</button></div>
          </div>
        </div>
        <div class="col-12 col-lg-8">
          <div class="card p-3 ring">
            <h5 class="mb-3">Budgets</h5>
            <div id="budList" class="vstack gap-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings -->
    <div class="tab-pane fade" id="pills-settings" role="tabpanel">
      <div class="card p-3 ring">
        <h5 class="mb-3">Settings & Connections</h5>
        <p class="text-secondary">Private app (session login). Add to iPhone Home Screen for PWA experience. Data saves to your browser; export/import JSON for backup.</p>

        <div class="row g-3">
          <div class="col-12 col-xl-6">
            <div class="p-3 ring h-100">
              <h6 class="mb-2"><i class="bi bi-link-45deg"></i> Connections</h6>
              <div id="connStatus" class="small-muted mb-2">Loadingâ€¦</div>
              <div class="d-flex flex-wrap gap-2 mb-2">
                <button id="connectBank" class="btn btn-primary btn-sm"><i class="bi bi-link-45deg"></i> Connect bank (Plaid)</button>
                <button id="syncTx" class="btn btn-outline-light btn-sm"><i class="bi bi-arrow-repeat"></i> Sync last 30 days</button>
              </div>
              <small class="text-secondary">Plaid is set for <b>transactions + investments</b> by default (sandbox or live).</small>

              <hr>
              <h6 class="mb-2"><i class="bi bi-upload"></i> Brokerage CSV Import</h6>
              <div class="vstack gap-2">
                <label class="btn btn-outline-light btn-sm">Import Robinhood CSV <input id="csvRobinhood" type="file" accept=".csv" hidden></label>
                <label class="btn btn-outline-light btn-sm">Import Coinbase CSV <input id="csvCoinbase" type="file" accept=".csv" hidden></label>
              </div>
              <small class="text-secondary d-block mt-1">Parses common CSVs into Transactions (or Flips by choice). You can edit after import.</small>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="p-3 ring h-100">
              <h6 class="mb-2"><i class="bi bi-tags"></i> Category Manager</h6>
              <div class="input-group mb-2">
                <input id="newCat" class="form-control" placeholder="Add categoryâ€¦"/>
                <button id="addCat" class="btn btn-primary btn-sm">Add</button>
              </div>
              <div id="catList" class="d-flex flex-wrap gap-2 small"></div>

              <hr>
              <h6 class="mb-2"><i class="bi bi-magic"></i> Auto-tag Rules</h6>
              <div class="row g-2">
                <div class="col-12 col-md-5">
                  <input id="ruleMatch" class="form-control" placeholder="If description containsâ€¦"/>
                </div>
                <div class="col-12 col-md-5">
                  <select id="ruleCat" class="form-select"></select>
                </div>
                <div class="col-12 col-md-2 d-grid">
                  <button id="addRule" class="btn btn-outline-primary btn-sm">Add Rule</button>
                </div>
              </div>
              <div class="table-responsive mt-2" style="max-height:200px;">
                <table class="table table-sm" id="ruleTable">
                  <thead><tr><th>Contains</th><th>Category</th><th class="text-end"></th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
              <small class="text-secondary">Rules apply when you add/sync transactions.</small>
            </div>
          </div>
        </div>

        <div class="form-check form-switch mt-3">
          <input class="form-check-input" type="checkbox" id="rolloverBills">
          <label class="form-check-label" for="rolloverBills">Auto-rollover paid bills to next month</label>
        </div>
      </div>
    </div>
  </div>
</main>

<footer class="sticky-footer py-2 px-3 d-flex justify-content-between align-items-center">
  <small class="text-secondary">PWA enabled Â· Works offline after first load</small>
  <small id="lastSaved" class="text-secondary">Not saved yet</small>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>

<script>
// ---------- PWA ----------
(function(){
  const swCode = `
    self.addEventListener('install', e => self.skipWaiting());
    self.addEventListener('activate', e => self.clients.claim());
    self.addEventListener('fetch', () => {});
  `;
  const blob = new Blob([swCode], {type:'text/javascript'});
  const swURL = URL.createObjectURL(blob);
  if ('serviceWorker' in navigator) navigator.serviceWorker.register(swURL);
})();

// ---------- State ----------
const SKEY = 'moneyhub_v2';
let state = JSON.parse(localStorage.getItem(SKEY) || '{}');
function initState(){
  if (!state.accounts) state.accounts = [];
  if (!state.transactions) state.transactions = [];
  if (!state.investments) state.investments = [];
  if (!state.flipTx) state.flipTx = [];
  if (!state.bills) state.bills = [];
  if (!state.categories) state.categories = ['Groceries','Dining','Gas','Rent','Utilities','Phone','Insurance','Subscriptions','Shopping','Income','Transfer','Transport'];
  if (!state.rules) state.rules = []; // {match:'uber', cat:'Transport'}
  if (!state.budgets) state.budgets = [];
  if (!state.settings) state.settings = {rolloverBills:false};
  if (state.cashOnHand == null) state.cashOnHand = 0;
}
initState();

function save(renderAfter=true){
  localStorage.setItem(SKEY, JSON.stringify(state));
  const ls = document.getElementById('lastSaved');
  if (ls) ls.textContent = 'Saved ' + new Date().toLocaleString();
  if (renderAfter) render();
}

// ---------- Utils ----------
function fmt(n){ const v=Number(n||0); const s=v<0?'-':''; return s+'$'+Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
function cid(){ return Math.random().toString(36).slice(2,9); }
function monthKey(d){ const x=new Date(d);return x.getFullYear()+"-"+String(x.getMonth()+1).padStart(2,'0'); }
function dateISOFrom(d){ return new Date(d).toISOString().slice(0,10); }
function today(offset=0){ const d=new Date(); d.setDate(d.getDate()+offset); return dateISOFrom(d); }
function firstOfNextMonth(){ const d=new Date(); d.setMonth(d.getMonth()+1,1); return dateISOFrom(d); }
function clamp2(n){ return Number(Number(n||0).toFixed(2)); }
function qs(sel){ return document.querySelector(sel); }
function esc(s){ return String(s==null?'':s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function selFill(sel, values, addAll=false){ const el=qs(sel); if(!el) return; el.innerHTML=''; values.forEach((v,i)=>{ const o=document.createElement('option'); o.textContent=v; if(addAll&&i===0)o.value=''; el.appendChild(o); }); }

// ---------- Demo ----------
function loadDemo(){
  state = {
    accounts:[
      {id:cid(), name:'Chase Checking', type:'Checking', balance:1240.55},
      {id:cid(), name:'Ally Savings', type:'Savings', balance:3500.00},
      {id:cid(), name:'Cash', type:'Cash', balance:120.00}
    ],
    transactions:[
      {id:cid(), date:today(-10), desc:'Gas', cat:'Gas', acct:'Chase Checking', amt:-42.70},
      {id:cid(), date:today(-3), desc:'HEB Groceries', cat:'Groceries', acct:'Chase Checking', amt:-68.34},
      {id:cid(), date:today(-1), desc:'DoorDash', cat:'Dining', acct:'Chase Checking', amt:-22.15},
      {id:cid(), date:today(-1), desc:'Paycheck', cat:'Income', acct:'Chase Checking', amt:850.00}
    ],
    investments:[
      {id:cid(), symbol:'VTI', cat:'Stock', subcat:'', qty:10, price:260, dividend_per_share:0.20, dividend_freq:'quarterly', drip:true},
      {id:cid(), symbol:'BTC', cat:'Crypto', subcat:'', qty:0.02, price:65000, dividend_per_share:0, dividend_freq:'none', drip:false}
    ],
    flipTx:[],
    bills:[
      {id:cid(), name:'Phone', amt:45, due:dateISOFrom(new Date(new Date().setDate(new Date().getDate()+5))), paid:false},
      {id:cid(), name:'Rent', amt:1200, due:firstOfNextMonth(), paid:false}
    ],
    categories:['Groceries','Dining','Gas','Rent','Utilities','Phone','Insurance','Subscriptions','Shopping','Income','Transfer','Transport'],
    rules:[{id:cid(), match:'uber', cat:'Transport'}],
    budgets:[{id:cid(), cat:'Groceries', monthly:300}, {id:cid(), cat:'Dining', monthly:120}],
    settings:{rolloverBills:false},
    cashOnHand:120
  };
  save();
}

// ---------- Dividends ----------
function monthsFromFreq(freq){ return freq==='monthly'?1:freq==='quarterly'?3:freq==='semiannual'?6:freq==='annual'?12:0; }
function projectDividends(h, years=10){
  const m = monthsFromFreq(h.dividend_freq||'none'); if(!m || !h.dividend_per_share) return {schedule:[], totalIncome:0};
  const steps = Math.floor((years*12)/m); let qty=Number(h.qty||0); const price=Number(h.price||0)||1; const dps=Number(h.dividend_per_share||0);
  const schedule=[]; let total=0;
  for(let i=1;i<=steps;i++){ const income=qty*dps; total+=income; if(h.drip){ qty += income/price; } schedule.push({period:i, qty, income, cumIncome:total}); }
  return {schedule, totalIncome: total};
}

// ---------- Rendering ----------
function render(){
  // KPIs
  const bankTotal = state.accounts.filter(a=>a.type!=='Cash').reduce((s,a)=> s + Number(a.balance||0), 0);
  const cashOnHand = Number(state.cashOnHand||0);
  const invTotal = state.investments.reduce((s,h)=> s + (Number(h.qty||0)*Number(h.price||0)), 0);
  const ccDebts = state.accounts.filter(a=>a.type==='Credit Card').reduce((s,a)=> s + Math.min(0, Number(a.balance||0)), 0);
  const ccPos   = state.accounts.filter(a=>a.type==='Credit Card').reduce((s,a)=> s + Math.max(0, Number(a.balance||0)), 0);
  const netWorth = (bankTotal + cashOnHand + invTotal + ccPos) + ccDebts;

  qs('#netWorth').textContent = fmt(netWorth);
  qs('#cashOnHand').textContent = fmt(cashOnHand);
  qs('#bankTotal').textContent = fmt(bankTotal);
  qs('#investTotal').textContent = fmt(invTotal);
  qs('#acctCount').textContent = state.accounts.length + ' accounts';

  // Accounts
  const atb = qs('#acctTable tbody'); atb.innerHTML='';
  state.accounts.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${esc(a.name)}</td><td>${esc(a.type)}</td>
      <td class="text-end">${fmt(Number(a.balance||0))}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-light" data-edit-acct="${a.id}"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" data-del-acct="${a.id}"><i class="bi bi-trash"></i></button>
      </td>`;
    atb.appendChild(tr);
  });
  qs('#acctSummary').textContent = state.accounts.length + ' accounts';

  // Investments
  const itb = qs('#invTable tbody'); itb.innerHTML='';
  state.investments.forEach(h=>{
    const val = Number(h.qty||0)*Number(h.price||0);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${esc(h.symbol)}</td><td>${esc(h.cat||'')}</td><td>${esc(h.subcat||'')}</td>
      <td class="text-end">${Number(h.qty||0)}</td>
      <td class="text-end">${fmt(Number(h.price||0))}</td>
      <td class="text-end">${fmt(val)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-light" data-edit-hold="${h.id}"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" data-del-hold="${h.id}"><i class="bi bi-trash"></i></button>
      </td>`;
    itb.appendChild(tr);
  });
  qs('#invSummary').textContent = state.investments.length + ' holdings';

  // Category selects
  selFill('#txCat', state.categories);
  selFill('#filterCat', ['All categories', ...state.categories], true);

  // Account selects
  selFill('#txAcct', state.accounts.map(a=>a.name));
  selFill('#filterAcct', ['All accounts', ...state.accounts.map(a=>a.name)], true);

  // Transactions
  renderTransactions();

  // Bills
  const btb = qs('#billTable tbody'); btb.innerHTML='';
  state.bills.sort((a,b)=> a.due.localeCompare(b.due));
  state.bills.forEach(b=>{
    const dueDays = (new Date(b.due) - new Date())/(1000*60*60*24);
    const badge = b.paid ? '<span class="badge bg-success">Paid</span>' :
                  (dueDays <= 7 ? '<span class="badge bg-warning text-dark">Due soon</span>' :
                                  '<span class="badge bg-secondary">Scheduled</span>');
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${esc(b.name)}</td><td>${b.due}</td>
      <td class="text-end">${fmt(Number(b.amt||0))}</td>
      <td>${badge}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-success" data-bpay="${b.id}"><i class="bi bi-check2"></i></button>
        <button class="btn btn-sm btn-outline-danger" data-bdel="${b.id}"><i class="bi bi-trash"></i></button>
      </td>`;
    btb.appendChild(tr);
  });
  qs('#billSummary').textContent = state.bills.length + ' scheduled';

  // Budgets
  const nowKey = monthKey(new Date());
  const list = qs('#budList'); list.innerHTML='';
  state.budgets.forEach(b=>{
    const spent = state.transactions
      .filter(t=> monthKey(t.date)===nowKey && t.cat===b.cat)
      .reduce((s,t)=> s + Math.min(0, Number(t.amt||0)), 0) * -1;
    const pct = Math.min(100, Math.round((spent / Number(b.monthly||1))*100));
    const wrap=document.createElement('div'); wrap.className='p-2 ring';
    wrap.innerHTML=`
      <div class="d-flex justify-content-between mb-1">
        <strong>${esc(b.cat)}</strong><span>${fmt(spent)} / ${fmt(Number(b.monthly||0))}</span>
      </div>
      <div class="progress"><div class="progress-bar ${pct>=100?'bg-danger':'bg-primary'}" style="width:${pct}%"></div></div>
      <div class="text-end mt-2">
        <button class="btn btn-sm btn-outline-light" data-bedit="${b.id}"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" data-brem="${b.id}"><i class="bi bi-trash"></i></button>
      </div>`;
    list.appendChild(wrap);
  });

  // Settings toggles
  const roll = qs('#rolloverBills'); if (roll) roll.checked = !!state.settings.rolloverBills;

  // Flips
  renderFlips();

  // Charts
  buildCharts();

  // Settings: status + category list + rules table
  refreshStatus();
  refreshCategories();
  refreshRulesUI();
}

function renderTransactions(){
  const ftCat = (qs('#filterCat')?.value || '');
  const ftAcct = (qs('#filterAcct')?.value || '');
  const tb = qs('#txTable tbody'); tb.innerHTML='';
  let rows = [...state.transactions];
  if (ftCat && ftCat !== 'All categories') rows = rows.filter(t=> t.cat===ftCat);
  if (ftAcct && ftAcct !== 'All accounts') rows = rows.filter(t=> t.acct===ftAcct);
  rows.sort((a,b)=> a.date.localeCompare(b.date) || a.id.localeCompare(b.id));
  rows.forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${t.date}</td><td>${esc(t.desc)}</td><td>${esc(t.cat)}</td><td>${esc(t.acct)}</td>
      <td class="text-end ${Number(t.amt)<0?'text-danger':'text-success'}">${fmt(Number(t.amt||0))}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-light" data-edit-tx="${t.id}"><i class="bi bi-pencil"></i></button>
        <button class="btn btn-sm btn-outline-danger" data-del-tx="${t.id}"><i class="bi bi-trash"></i></button>
      </td>`;
    tb.appendChild(tr);
  });
}

// ---------- Charts ----------
let chartNW, chartSpend, chartFlipROI;
function buildCharts(){
  try {
    chartNW && chartNW.destroy();
    chartSpend && chartSpend.destroy();

    // labels last 12 months
    const labels=[]; const todayD=new Date();
    for(let k=11;k>=0;k--){ const d=new Date(todayD.getFullYear(), todayD.getMonth()-k, 1); labels.push(d.toLocaleDateString(undefined,{month:'short',year:'2-digit'})); }

    // net worth snapshots (simple)
    const nwData=[]; for(let k=11;k>=0;k--){
      const bankTotal = state.accounts.filter(a=>a.type!=='Cash').reduce((s,a)=> s + Number(a.balance||0), 0);
      const cash = Number(state.cashOnHand||0);
      const inv = state.investments.reduce((s,h)=> s + Number(h.qty||0)*Number(h.price||0), 0);
      const ccDebts = state.accounts.filter(a=>a.type==='Credit Card').reduce((s,a)=> s + Math.min(0, Number(a.balance||0)), 0);
      const ccPos   = state.accounts.filter(a=>a.type==='Credit Card').reduce((s,a)=> s + Math.max(0, Number(a.balance||0)), 0);
      nwData.push(Number(((bankTotal+cash+inv+ccPos)+ccDebts).toFixed(2)));
    }

    // spending by month
    const spendData=[]; for(let k=11;k>=0;k--){
      const m=new Date(todayD.getFullYear(), todayD.getMonth()-k,1);
      const key=m.getFullYear()+'-'+String(m.getMonth()+1).padStart(2,'0');
      const spent=state.transactions.filter(t=>monthKey(t.date)===key).reduce((s,t)=>s+Math.min(0,Number(t.amt||0)),0)*-1;
      spendData.push(Number(spent.toFixed(2)));
    }

    const ctxNW=document.getElementById('chartNetWorth');
    const ctxSP=document.getElementById('chartSpending');
    if(ctxNW){ chartNW=new Chart(ctxNW,{type:'line',data:{labels,datasets:[{label:'Net Worth',data:nwData}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:false}}}}); }
    if(ctxSP){ chartSpend=new Chart(ctxSP,{type:'bar',data:{labels,datasets:[{label:'Spending',data:spendData}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}}); }

    // flips ROI
    buildFlipROIChart();
  } catch(e){ console.error(e); }
}

// ---------- Dividend UI ----------
let chartDiv;
function refreshProjectionOptions(){
  const sel = qs('#projHolding'); if(!sel) return;
  const cur = sel.value; sel.innerHTML='';
  state.investments.forEach(h=>{ const o=document.createElement('option'); o.value=h.id; o.textContent=`${h.symbol} ${h.cat?'Â· '+h.cat:''} ${h.subcat?'Â· '+h.subcat:''}`; sel.appendChild(o); });
  if (cur) sel.value=cur;
}
function buildDividendProjection(){
  const sel=qs('#projHolding'), yrsEl=qs('#projYears'), dripEl=qs('#projDrip'); if(!sel||!yrsEl) return;
  const h = state.investments.find(x=>x.id===sel.value); const years=Math.max(1,Math.min(30,Number(yrsEl.value||10)));
  if(!h){ chartDiv&&chartDiv.destroy(); qs('#projTable tbody').innerHTML=''; return; }
  const tmp={...h, drip:(dripEl?.checked?true:!!h.drip)}; const {schedule}=projectDividends(tmp, years);

  const tb=qs('#projTable tbody'); tb.innerHTML='';
  schedule.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.period}</td><td class="text-end">${Number(r.qty).toFixed(4)}</td><td class="text-end">${fmt(r.income)}</td><td class="text-end">${fmt(r.cumIncome)}</td>`; tb.appendChild(tr); });
  const labels=schedule.map(x=>x.period), income=schedule.map(x=>Number(x.income.toFixed(2))), cum=schedule.map(x=>Number(x.cumIncome.toFixed(2)));
  const ctx=document.getElementById('chartDividend'); if(ctx){ chartDiv&&chartDiv.destroy(); chartDiv=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Dividend Income',data:income},{label:'Cumulative Income',data:cum}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}}); }
}
qs('#projHolding')?.addEventListener('change', buildDividendProjection);
qs('#projYears')?.addEventListener('input', buildDividendProjection);
qs('#projDrip')?.addEventListener('change', buildDividendProjection);

// ---------- Flips ----------
function renderFlips(){
  const tb=qs('#flipTable tbody'); tb.innerHTML='';
  state.flipTx.sort((a,b)=>a.date.localeCompare(b.date));
  state.flipTx.forEach(f=>{
    const total = (Number(f.qty||0)*Number(f.price||0)) + Number(f.fees||0);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${esc(f.subcat||'')}</td><td>${esc(f.item||'')}</td><td>${f.date||''}</td><td>${f.side||''}</td>
      <td class="text-end">${Number(f.qty||0)}</td>
      <td class="text-end">${fmt(Number(f.price||0))}</td>
      <td class="text-end">${fmt(Number(f.fees||0))}</td>
      <td class="text-end">${fmt(total)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-danger" data-del-flip="${f.id}"><i class="bi bi-trash"></i></button>
      </td>`;
    tb.appendChild(tr);
  });
  qs('#flipSummary').textContent = state.flipTx.length + ' entries';
}

function flipAggregates(){
  const agg={}; // subcat -> {cost, proceeds, qtyBuy, qtySell}
  state.flipTx.forEach(f=>{
    const key=f.subcat||'Uncategorized';
    if (!agg[key]) agg[key]={cost:0, proceeds:0, qtyBuy:0, qtySell:0};
    const total=(Number(f.qty||0)*Number(f.price||0))+Number(f.fees||0);
    if (f.side==='buy'){ agg[key].cost += total; agg[key].qtyBuy += Number(f.qty||0); }
    else { agg[key].proceeds += total; agg[key].qtySell += Number(f.qty||0); }
  });
  const rows = Object.entries(agg).map(([sub,a])=>{
    const pnl = a.proceeds - a.cost;
    const roi = a.cost ? (pnl/a.cost)*100 : (a.proceeds?100:0);
    const inv = a.qtyBuy - a.qtySell;
    return {sub, cost:clamp2(a.cost), proceeds:clamp2(a.proceeds), pnl:clamp2(pnl), roi:clamp2(roi), inventory:inv};
  });
  return rows.sort((x,y)=> y.pnl - x.pnl);
}

function buildFlipROIChart(){
  const rows=flipAggregates();
  const ctx=document.getElementById('chartFlipROI');
  if (!ctx) return;
  chartFlipROI && chartFlipROI.destroy();
  chartFlipROI = new Chart(ctx,{
    type:'bar',
    data:{ labels: rows.map(r=>r.sub), datasets:[{label:'P&L', data: rows.map(r=>r.pnl)}] },
    options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });
  const tb=qs('#flipAggTable tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${esc(r.sub)}</td><td class="text-end">${fmt(r.cost)}</td><td class="text-end">${fmt(r.proceeds)}</td><td class="text-end">${fmt(r.pnl)}</td><td class="text-end">${r.roi.toFixed(2)}%</td><td class="text-end">${r.inventory}</td>`;
    tb.appendChild(tr);
  });
}

// ---------- Events (CRUD) ----------
document.addEventListener('click',(e)=>{
  const t=e.target.closest('button'); if(!t) return;

  // Accounts
  if (t.dataset.delAcct){ state.accounts=state.accounts.filter(a=>a.id!==t.dataset.delAcct); save(); }
  if (t.dataset.editAcct){
    const a=state.accounts.find(x=>x.id===t.dataset.editAcct); if(!a) return;
    const name=prompt('Account name:',a.name); if(name==null) return;
    const type=prompt('Type (Checking/Savings/Credit Card/Cash/Other):',a.type); if(type==null) return;
    const bal=prompt('Balance:',a.balance); if(bal==null) return;
    Object.assign(a,{name:name.trim(), type:type.trim(), balance:clamp2(bal)}); save();
  }

  // Holdings
  if (t.dataset.delHold){ state.investments=state.investments.filter(h=>h.id!==t.dataset.delHold); save(); }
  if (t.dataset.editHold){
    const h=state.investments.find(x=>x.id===t.dataset.editHold); if(!h) return;
    const s=prompt('Symbol/Name:',h.symbol); if(s==null) return;
    const c=prompt('Category (Stock/Crypto/Flip):',h.cat||'Stock'); if(c==null) return;
    const sub=prompt('Sub-category:',h.subcat||''); if(sub==null) return;
    const q=prompt('Quantity:',h.qty); if(q==null) return;
    const p=prompt('Price:',h.price); if(p==null) return;
    const dps=prompt('Dividend per share (0 if none):',h.dividend_per_share||0); if(dps==null) return;
    const fr=prompt('Dividend frequency (none/monthly/quarterly/semiannual/annual):',h.dividend_freq||'none'); if(fr==null) return;
    const drip=confirm('Enable DRIP? (OK=yes)');
    Object.assign(h,{symbol:s.trim(),cat:c.trim(),subcat:sub.trim(),qty:Number(q||0),price:clamp2(p),dividend_per_share:clamp2(dps),dividend_freq:fr.trim(),drip}); save();
  }

  // Transactions
  if (t.dataset.delTx){ state.transactions=state.transactions.filter(x=>x.id!==t.dataset.delTx); save(); }
  if (t.dataset.editTx){
    const x=state.transactions.find(y=>y.id===t.dataset.editTx); if(!x) return;
    const d=prompt('Date (YYYY-MM-DD):',x.date); if(d==null) return;
    const de=prompt('Description:',x.desc); if(de==null) return;
    const c=prompt('Category:',x.cat); if(c==null) return;
    const a=prompt('Account:',x.acct); if(a==null) return;
    const am=prompt('Amount (use - for expense):',x.amt); if(am==null) return;
    Object.assign(x,{date:d, desc:de, cat:c, acct:a, amt:clamp2(am)}); save();
  }

  // Bills
  if (t.dataset.bpay){
    const b=state.bills.find(z=>z.id===t.dataset.bpay); if(!b) return;
    b.paid=true;
    if (state.settings.rolloverBills){ const nd=new Date(b.due); nd.setMonth(nd.getMonth()+1); state.bills.push({id:cid(),name:b.name,amt:b.amt,due:dateISOFrom(nd),paid:false}); }
    save();
  }
  if (t.dataset.bdel){ state.bills=state.bills.filter(z=>z.id!==t.dataset.bdel); save(); }

  // Budgets
  if (t.dataset.bedit){ const b=state.budgets.find(z=>z.id===t.dataset.bedit); if(!b) return; const cat=prompt('Budget category:',b.cat); if(cat==null)return; const m=prompt('Monthly limit:',b.monthly); if(m==null)return; Object.assign(b,{cat:cat.trim(),monthly:clamp2(m)}); save(); }
  if (t.dataset.brem){ state.budgets=state.budgets.filter(z=>z.id!==t.dataset.brem); save(); }

  // Flips
  if (t.dataset.delFlip){ state.flipTx=state.flipTx.filter(x=>x.id!==t.dataset.delFlip); save(); }
});

// Add Account
qs('#addAcct')?.addEventListener('click', ()=>{
  const name=qs('#acctName').value.trim(), type=qs('#acctType').value.trim(), bal=clamp2(qs('#acctBalance').value);
  if (!name) return alert('Account name is required.');
  state.accounts.push({id:cid(), name, type, balance:bal});
  qs('#acctName').value=''; qs('#acctBalance').value=''; save();
});

// Demo
qs('#resetDemo')?.addEventListener('click', loadDemo);

// Cash on hand
qs('#saveCash')?.addEventListener('click', ()=>{
  const val=clamp2(qs('#cashInput').value); state.cashOnHand=val;
  const cashAcct = state.accounts.find(a=>a.type==='Cash'||/cash/i.test(a.name));
  if (cashAcct) cashAcct.balance=val; else state.accounts.push({id:cid(), name:'Cash', type:'Cash', balance:val});
  save();
});

// Add Holding
qs('#addInv')?.addEventListener('click', ()=>{
  const symbol=qs('#invSymbol').value.trim(), cat=qs('#invCat')?.value||'Stock', subcat=qs('#invSubcat')?.value.trim()||'';
  const qty=Number(qs('#invQty').value||0), price=clamp2(qs('#invPrice').value);
  const divPS=clamp2(qs('#invDivPS')?.value||0), divFreq=qs('#invDivFreq')?.value||'none', drip=!!qs('#invDrip')?.checked;
  if (!symbol) return alert('Enter a symbol or name.');
  state.investments.push({id:cid(), symbol, cat, subcat, qty, price, dividend_per_share:divPS, dividend_freq:divFreq, drip});
  ['invSymbol','invSubcat','invQty','invPrice','invDivPS'].forEach(id=>{const el=qs('#'+id); if(el) el.value='';});
  if (qs('#invDivFreq')) qs('#invDivFreq').value='none'; if (qs('#invDrip')) qs('#invDrip').checked=false; save();
});

// Add Transaction (+ apply rules)
qs('#addTx')?.addEventListener('click', ()=>{
  const date=qs('#txDate').value||today(), desc=qs('#txDesc').value.trim()||'Transaction';
  let cat=qs('#txCat').value||'Other'; const acct=qs('#txAcct').value||(state.accounts[0]?.name||'Unknown');
  const amt=clamp2(qs('#txAmt').value); if (isNaN(amt)) return alert('Enter a numeric amount.');
  // auto-tag rules
  const dlow=desc.toLowerCase(); const rule=state.rules.find(r=> dlow.includes(r.match.toLowerCase()));
  if (rule) cat = rule.cat;
  state.transactions.push({id:cid(), date, desc, cat, acct, amt});
  const a=state.accounts.find(x=>x.name===acct); if (a) a.balance = clamp2(Number(a.balance||0) + amt);
  qs('#txDesc').value=''; qs('#txAmt').value=''; save();
});

// Filters
qs('#filterCat')?.addEventListener('change', renderTransactions);
qs('#filterAcct')?.addEventListener('change', renderTransactions);

// Bills quick add
qs('#addBill')?.addEventListener('click', ()=>{
  const name=qs('#billName').value.trim(), amt=clamp2(qs('#billAmt').value), due=qs('#billDue').value||firstOfNextMonth();
  if (!name) return alert('Bill name required.');
  state.bills.push({id:cid(), name, amt, due, paid:false});
  qs('#billName').value=''; qs('#billAmt').value=''; qs('#billDue').value=''; save();
});

// Budgets
qs('#addBudget')?.addEventListener('click', ()=>{
  const cat=qs('#budCat').value.trim(), amt=clamp2(qs('#budAmt').value); if(!cat) return alert('Budget category required.');
  state.budgets.push({id:cid(), cat, monthly:amt}); qs('#budCat').value=''; qs('#budAmt').value=''; save();
});

// Settings toggles
qs('#rolloverBills')?.addEventListener('change', e=>{ state.settings.rolloverBills=!!e.target.checked; save(false); });

// Export / Import
qs('#exportBtn')?.addEventListener('click', ()=>{
  const data=JSON.stringify(state,null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`moneyhub_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
qs('#importFile')?.addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{ const text=await f.text(); const obj=JSON.parse(text); state=obj; initState(); save(); alert('Import complete!'); }catch(err){ console.error(err); alert('Import failed: invalid file.'); } finally{ e.target.value=''; }
});

// CSV import (general tx)
document.getElementById('csvTx')?.addEventListener('change', e=> parseCsvToTx(e.target.files?.[0]));
function parseCSV(str){
  const rows=[]; let row=[],cur='',inQ=false;
  for(let i=0;i<str.length;i++){ const ch=str[i];
    if(inQ){ if(ch=='"'){ if(str[i+1]=='"'){cur+='"';i++;} else inQ=false; } else cur+=ch; }
    else{ if(ch=='"') inQ=true; else if(ch==','){row.push(cur);cur='';} else if(ch=='\n'||ch=='\r'){ if(cur.length||row.length){row.push(cur);rows.push(row);row=[];cur='';} if(ch=='\r'&&str[i+1]=='\n')i++; } else cur+=ch; }
  }
  if(cur.length||row.length){row.push(cur);rows.push(row);} return rows;
}
function parseCsvToTx(file){
  if(!file) return; const r=new FileReader();
  r.onload=()=>{ const rows=parseCSV(r.result||''); if(!rows.length) return alert('No rows found.');
    const header=rows[0].map(h=>String(h||'').trim().toLowerCase());
    const idx={date:header.indexOf('date'),description:header.indexOf('description'),amount:header.indexOf('amount'),category:header.indexOf('category'),account:header.indexOf('account')};
    if(Object.values(idx).some(v=>v<0)) return alert('CSV must include headers: date,description,amount,category,account');
    for(let i=1;i<rows.length;i++){ const row=rows[i]; if(!row||!row.length) continue;
      let desc=String(row[idx.description]||'').trim()||'Transaction'; let cat=String(row[idx.category]||'Other').trim()||'Other';
      const acct=String(row[idx.account]||'').trim()||(state.accounts[0]?.name||'Unknown'); const amt=clamp2(row[idx.amount]||0); const date=String(row[idx.date]||today()).slice(0,10);
      // rules
      const rule=state.rules.find(r=> desc.toLowerCase().includes(r.match.toLowerCase())); if(rule) cat=rule.cat;
      state.transactions.push({id:cid(), date, desc, cat, acct, amt});
      const a=state.accounts.find(x=>x.name===acct); if(a) a.balance=clamp2(Number(a.balance||0)+Number(amt||0));
    }
    save(); alert('CSV import complete!'); };
  r.readAsText(file);
}

// Brokerage CSV shortcuts
document.getElementById('csvRobinhood')?.addEventListener('change', e=> parseCsvToTx(e.target.files?.[0]));
document.getElementById('csvCoinbase')?.addEventListener('change', e=> parseCsvToTx(e.target.files?.[0]));

// Category Manager
function refreshCategories(){
  const cont=qs('#catList'); if(!cont) return; cont.innerHTML='';
  state.categories.forEach(c=>{ const b=document.createElement('span'); b.className='badge bg-secondary d-flex align-items-center gap-1 p-2';
    b.innerHTML=`${esc(c)} <button class="btn btn-sm btn-outline-light py-0 px-1" data-del-cat="${c}"><i class="bi bi-x"></i></button>`;
    cont.appendChild(b);
  });
  selFill('#ruleCat', state.categories);
}
qs('#addCat')?.addEventListener('click', ()=>{
  const v=qs('#newCat').value.trim(); if(!v) return;
  if(!state.categories.includes(v)) state.categories.push(v);
  qs('#newCat').value=''; save(false); refreshCategories();
});
document.addEventListener('click',(e)=>{ const t=e.target.closest('button'); if(!t) return; if(t.dataset.delCat){ const c=t.dataset.delCat; state.categories=state.categories.filter(x=>x!==c); save(false); refreshCategories(); }});

// Rules
function refreshRulesUI(){
  selFill('#ruleCat', state.categories);
  const tb=qs('#ruleTable tbody'); if(!tb) return; tb.innerHTML='';
  state.rules.forEach(r=>{ const tr=document.createElement('tr');
    tr.innerHTML=`<td>${esc(r.match)}</td><td>${esc(r.cat)}</td><td class="text-end"><button class="btn btn-sm btn-outline-danger" data-del-rule="${r.id}"><i class="bi bi-trash"></i></button></td>`;
    tb.appendChild(tr);
  });
}
qs('#addRule')?.addEventListener('click', ()=>{
  const match=qs('#ruleMatch').value.trim(); const cat=qs('#ruleCat').value;
  if(!match || !cat) return alert('Enter match text and choose a category.');
  state.rules.push({id:cid(), match, cat}); qs('#ruleMatch').value=''; save(false); refreshRulesUI();
});
document.addEventListener('click',(e)=>{ const t=e.target.closest('button'); if(!t) return; if(t.dataset.delRule){ state.rules=state.rules.filter(r=>r.id!==t.dataset.delRule); save(false); refreshRulesUI(); }});

// Flips add
qs('#addFlip')?.addEventListener('click', ()=>{
  const f={ id:cid(), date:qs('#flipDate').value||today(), subcat:qs('#flipSubcat').value.trim(), item:qs('#flipItem').value.trim(),
            side:qs('#flipSide').value, qty:Number(qs('#flipQty').value||1), price:clamp2(qs('#flipPrice').value), fees:clamp2(qs('#flipFees').value) };
  if (!f.item) return alert('Item name required.');
  state.flipTx.push(f);
  ['flipSubcat','flipItem','flipQty','flipPrice','flipFees'].forEach(id=>{const el=qs('#'+id); if(el) el.value='';}); save();
  buildFlipROIChart();
});

// Settings: connection status
async function refreshStatus(){
  try{
    const r=await fetch('/api/status'); if(!r.ok) throw 0; const d=await r.json();
    const s=qs('#connStatus'); if(s) s.textContent = d.plaid.linked ? `Plaid: linked (${d.plaid.env}; ${d.plaid.products.join(', ')})` : `Plaid: not linked (${d.plaid.env}; ${d.plaid.products.join(', ')})`;
  }catch{ const s=qs('#connStatus'); if(s) s.textContent='Plaid status unavailable'; }
}

// Plaid connect/sync
async function connectBank(){
  try{
    const r=await fetch('/plaid/create_link_token',{method:'POST'}); const data=await r.json();
    if(!data.link_token) { alert(data.error||'Plaid not configured.'); return; }
    const handler=Plaid.create({ token:data.link_token, onSuccess: async (public_token)=>{ await fetch('/plaid/exchange_public_token',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({public_token})}); alert('Bank linked! You can Sync transactions now.'); refreshStatus(); }, onExit:(err)=>{ if(err) console.error(err); } });
    handler.open();
  }catch(e){ console.error(e); alert('Connect failed.'); }
}
async function syncTransactionsFromBank(){
  try{
    const r=await fetch('/api/transactions'); const data=await r.json();
    if(!data.transactions){ alert(data.error||'No transactions'); return; }
    const acctName='Plaid Checking';
    if(!state.accounts.find(a=>a.name===acctName)) state.accounts.push({id:cid(), name:acctName, type:'Checking', balance:0});
    data.transactions.forEach(t=>{
      const amt = (t.amount>0)? -Number(t.amount) : Math.abs(Number(t.amount)); // convert Plaid sign
      // rules
      let cat = t.category || 'Other'; const dlow=(t.name||'').toLowerCase(); const rule=state.rules.find(r=> dlow.includes(r.match.toLowerCase())); if(rule) cat=rule.cat;
      state.transactions.push({id:cid(), date:t.date, desc:t.name||'Transaction', cat, acct:acctName, amt:clamp2(amt)});
      const a=state.accounts.find(x=>x.name===acctName); if(a) a.balance=clamp2(Number(a.balance||0)+amt);
    });
    save(); alert(`Imported ${data.transactions.length} transactions.`);
  }catch(e){ console.error(e); alert('Sync failed.'); }
}
qs('#connectBank')?.addEventListener('click', connectBank);
qs('#syncTx')?.addEventListener('click', syncTransactionsFromBank);

// Hook dividend UI refresh after render
const _renderCore = render;
render = function(){ _renderCore(); refreshProjectionOptions(); buildDividendProjection(); };

// Initial render
render();
</script>
</body>
</html>
